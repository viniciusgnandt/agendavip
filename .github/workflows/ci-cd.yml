name: CI/CD Backend + Frontend

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      image_tag:
        description: "Tag da imagem para deploy em PROD (ex: sha-abc1234)"
        required: true
      target:
        description: "Qual app fazer deploy"
        type: choice
        options:
          - backend
          - frontend
          - both

env:
  REGISTRY: ghcr.io
  OWNER: ${{ github.repository_owner }}
  BACKEND_IMAGE: ghcr.io/${{ github.repository_owner }}/ws
  FRONTEND_IMAGE: ghcr.io/${{ github.repository_owner }}/web

# ======================
# DETECTA ALTERAÇÕES
# ======================
jobs:
  Check:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}

    steps:
      - uses: actions/checkout@v4

      - name: Detect changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'ws/**'
            frontend:
              - 'web/**'

# ======================
# BUILD
# ======================
  build:
    runs-on: ubuntu-latest
    needs: changes
    outputs:
      tag: ${{ steps.tag.outputs.tag }}

    steps:
      - uses: actions/checkout@v4

      - name: Set image tag (commit SHA)
        id: tag
        run: |
          TAG=sha-${GITHUB_SHA::7}
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build & Push Backend
        if: needs.changes.outputs.backend == 'true'
        run: |
          docker build --no-cache \
            -t $BACKEND_IMAGE:${{ steps.tag.outputs.tag }} \
            -t $BACKEND_IMAGE:latest \
            ./ws

          docker push $BACKEND_IMAGE:${{ steps.tag.outputs.tag }}
          docker push $BACKEND_IMAGE:latest

      - name: Build & Push Frontend
        if: needs.changes.outputs.frontend == 'true'
        run: |
          docker build --no-cache \
            -t $FRONTEND_IMAGE:${{ steps.tag.outputs.tag }} \
            -t $FRONTEND_IMAGE:latest \
            ./web

          docker push $FRONTEND_IMAGE:${{ steps.tag.outputs.tag }}
          docker push $FRONTEND_IMAGE:latest

# ======================
# DEPLOY TEST (AUTO)
# ======================
  deploy_test:
    runs-on: ubuntu-latest
    needs: [build, changes]

    steps:
      - name: Deploy Backend TEST
        if: needs.changes.outputs.backend == 'true'
        run: |
          curl -X POST ${{ secrets.PORTAINER_WEBHOOK_BACKEND_TEST }}

      - name: Deploy Frontend TEST
        if: needs.changes.outputs.frontend == 'true'
        run: |
          curl -X POST ${{ secrets.PORTAINER_WEBHOOK_FRONTEND_TEST }}

# ======================
# DEPLOY PROD (MANUAL)
# ======================
  deploy_prod:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Deploy Backend PROD
        if: github.event.inputs.target == 'backend' || github.event.inputs.target == 'both'
        run: |
          curl -X POST \
          -H "Content-Type: application/json" \
          -d '{"image":"'"$BACKEND_IMAGE:${{ github.event.inputs.image_tag }}"'"}' \
          ${{ secrets.PORTAINER_WEBHOOK_BACKEND_PROD }}

      - name: Deploy Frontend PROD
        if: github.event.inputs.target == 'frontend' || github.event.inputs.target == 'both'
        run: |
          curl -X POST \
          -H "Content-Type: application/json" \
          -d '{"image":"'"$FRONTEND_IMAGE:${{ github.event.inputs.image_tag }}"'"}' \
          ${{ secrets.PORTAINER_WEBHOOK_FRONTEND_PROD }}